<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>My Project: cc_fabmap_node.cpp File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">My Project
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">cc_fabmap_node.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;ros/ros.h&gt;</code><br/>
<code>#include &lt;sensor_msgs/image_encodings.h&gt;</code><br/>
<code>#include &lt;message_filters/subscriber.h&gt;</code><br/>
<code>#include &lt;sensor_msgs/Image.h&gt;</code><br/>
<code>#include &lt;message_filters/time_synchronizer.h&gt;</code><br/>
<code>#include &lt;tf/transform_broadcaster.h&gt;</code><br/>
<code>#include &lt;image_transport/image_transport.h&gt;</code><br/>
<code>#include &lt;cv_bridge/cv_bridge.h&gt;</code><br/>
<code>#include &lt;opencv2/highgui/highgui.hpp&gt;</code><br/>
<code>#include &lt;opencv2/imgproc/imgproc.hpp&gt;</code><br/>
<code>#include &lt;opencv2/opencv.hpp&gt;</code><br/>
<code>#include &quot;opencv2/nonfree/nonfree.hpp&quot;</code><br/>
<code>#include &quot;<a class="el" href="KeyFrameListenerTraining_8h_source.html">KeyFrameListenerTraining.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="SyncListener_8h_source.html">SyncListener.h</a>&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for cc_fabmap_node.cpp:</div>
<div class="dyncontent">
<div class="center"><img src="cc__fabmap__node_8cpp__incl.png" border="0" usemap="#cc__fabmap__node_8cpp" alt=""/></div>
<map name="cc__fabmap__node_8cpp" id="cc__fabmap__node_8cpp">
<area shape="rect" id="node27" href="KeyFrameListenerTraining_8h.html" title="KeyFrameListenerTraining.h" alt="" coords="1891,83,2075,112"/><area shape="rect" id="node93" href="SyncListener_8h.html" title="SyncListener.h" alt="" coords="5021,83,5131,112"/><area shape="rect" id="node34" href="CentralStorage_8h.html" title="CentralStorage.h" alt="" coords="2389,160,2509,189"/><area shape="rect" id="node78" href="HelperFcts_8h.html" title="HelperFcts.h" alt="" coords="4261,237,4357,267"/><area shape="rect" id="node89" href="KalmanFilterScale_8h.html" title="KalmanFilterScale.h" alt="" coords="1277,237,1416,267"/><area shape="rect" id="node91" href="PoseGraph_8h.html" title="PoseGraph.h" alt="" coords="1440,237,1539,267"/></map>
</div>
</div>
<p><a href="cc__fabmap__node_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a99cb8485ba55364caae90a9d3d8d6609">helperDispOutput</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage, bool saveMatchMatrix=false, string matchMatrixNameImg=&quot;&quot;, string matchMatrixNameFile=&quot;&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a959fee195cd952ecb7f06befa08f4024">helperGetTestData</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a9665aef254686f428f555d32c1b30fa8">helperPublishAssembledGlobalPtCl</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage, ros::Publisher &amp;pub, int skipFirstN)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a085df1b3fc0cf52d21284c92297e891c">helperPublishAssembledLocalPtCl</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage, int rID, ros::Publisher &amp;pub, int skipFirstN)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#aa9b6e90f43cc74d5b9e6a0d4d4304eef">helperPublishPtCl</a> (pcl::PointCloud&lt; pcl::PointXYZ &gt; ptCl, ros::Publisher &amp;pub)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a2a2548ab36e98be49fd91e373ee89684">helperReadTrainData</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a8254506cb42ab9e85d3123dbbea7ce49">helperSaveTestImgs</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage, <a class="el" href="classSyncListener.html">SyncListener</a> &amp;listener_r1, <a class="el" href="classSyncListener.html">SyncListener</a> &amp;listener_r2)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a060e73dd74d1e5d07b42755cd9ffb1e2">helperSaveTrainData</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#af41fb2ed487a54eae76961955d42190b">helperStoreTrainData</a> (<a class="el" href="classCentralStorage.html">CentralStorage</a> *storage, <a class="el" href="classKeyFrameListenerTraining.html">KeyFrameListenerTraining</a> &amp;listenerR1, <a class="el" href="classKeyFrameListenerTraining.html">KeyFrameListenerTraining</a> &amp;listenerR2)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a> = 0</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a99cb8485ba55364caae90a9d3d8d6609"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperDispOutput" ref="a99cb8485ba55364caae90a9d3d8d6609" args="(CentralStorage *storage, bool saveMatchMatrix=false, string matchMatrixNameImg=&quot;&quot;, string matchMatrixNameFile=&quot;&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a99cb8485ba55364caae90a9d3d8d6609">helperDispOutput</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>saveMatchMatrix</em> = <code>false</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>matchMatrixNameImg</em> = <code>&quot;&quot;</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>matchMatrixNameFile</em> = <code>&quot;&quot;</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00042">42</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                                                        {
        <span class="keywordtype">int</span> nbrImgs = storage-&gt;<a class="code" href="classCentralStorage.html#ab3aae9d93bbccd2a646330cb8812824f">testBOWDescriptors_allRobots</a>.size().height; <span class="comment">// query img + test imgs</span>
        <span class="keywordtype">int</span> queryCtr = 0;

        Mat match_small_f = Mat::zeros(nbrImgs, nbrImgs, CV_32FC1);
        Mat matchMatrixRGB = Mat::zeros(nbrImgs,nbrImgs,CV_32FC3);

        vector&lt;of2::IMatch&gt;::const_iterator l;
        <span class="keywordflow">for</span>(l = storage-&gt;<a class="code" href="classCentralStorage.html#af2ce7451320774bb90db744fa46493bd">matches</a>.begin(); l != storage-&gt;<a class="code" href="classCentralStorage.html#af2ce7451320774bb90db744fa46493bd">matches</a>.end(); l++) {
<span class="comment">// USEFUL FOR DEBUG:            cout &lt;&lt; &quot;queryIdx: &quot; &lt;&lt; l-&gt;queryIdx &lt;&lt; &quot;   imgIdx: &quot; &lt;&lt; l-&gt;imgIdx &lt;&lt; &quot;   match: &quot; &lt;&lt; l-&gt;match &lt;&lt; endl;</span>
                <span class="keywordflow">if</span>(l-&gt;imgIdx &lt; 0) {
                        match_small_f.at&lt;<span class="keywordtype">float</span>&gt;(queryCtr, queryCtr) = (l-&gt;match*1.0);
                        <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.at(queryCtr).rID == 1) {
                                matchMatrixRGB.at&lt;Vec3f&gt;(queryCtr, queryCtr).val[0] = l-&gt;match*255.0; <span class="comment">// .at(col,row)</span>
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.at(queryCtr).rID == 2) {
                                matchMatrixRGB.at&lt;Vec3f&gt;(queryCtr, queryCtr).val[1] = l-&gt;match*255.0;
                        }
                        queryCtr = queryCtr + 1;

                } <span class="keywordflow">else</span> {
                        match_small_f.at&lt;<span class="keywordtype">float</span>&gt;(queryCtr-1, l-&gt;imgIdx) = (l-&gt;match*1.0);
                        <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.at(l-&gt;imgIdx).rID == 1) {
                                matchMatrixRGB.at&lt;Vec3f&gt;(queryCtr-1, l-&gt;imgIdx).val[0] = l-&gt;match*255.0;
                        }
                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.at(l-&gt;imgIdx).rID == 2) {
                                matchMatrixRGB.at&lt;Vec3f&gt;(queryCtr-1, l-&gt;imgIdx).val[1] = l-&gt;match*255.0;
                        }
                }
        }

        <span class="comment">//cout &lt;&lt; match_small_f &lt;&lt; endl;</span>
        <span class="comment">//Mat match_large_f(10*nbrImgs, 10*nbrImgs, CV_32FC1);</span>
        Mat matchMatrixRGB_large = Mat::zeros(10*nbrImgs,10*nbrImgs,CV_32FC3);

        <span class="comment">//resize(match_small_f, match_large_f, Size(500, 500), 0, 0, CV_INTER_NN);</span>
        resize(matchMatrixRGB, matchMatrixRGB_large, Size(500, 500), 0, 0, CV_INTER_NN);

        <span class="keywordflow">if</span>(saveMatchMatrix) {
                <a class="code" href="classHelperFcts.html#a62a2cbe4631785fe2e85c9131153d8f6">HelperFcts::saveImage</a>(matchMatrixRGB_large,matchMatrixNameImg);
                <a class="code" href="classHelperFcts.html#a64c4237c737ffe6a9f06194d65a762bc">HelperFcts::saveMatrix</a>(matchMatrixRGB,matchMatrixNameFile);
        }

        <span class="comment">/*</span>
<span class="comment">         *              I0 I1 I2 I3 ... I23 Q</span>
<span class="comment">         * I0</span>
<span class="comment">         * I1</span>
<span class="comment">         * I2</span>
<span class="comment">         * ...</span>
<span class="comment">         *</span>
<span class="comment">         * I23</span>
<span class="comment">         * Q</span>
<span class="comment">         */</span>
        imshow(<span class="stringliteral">&quot;Confusion match probab Matrix&quot;</span>, matchMatrixRGB_large/255.0);

        waitKey(5);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a959fee195cd952ecb7f06befa08f4024"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperGetTestData" ref="a959fee195cd952ecb7f06befa08f4024" args="(CentralStorage *storage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a959fee195cd952ecb7f06befa08f4024">helperGetTestData</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00100">100</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                {

        <span class="comment">//std::vector&lt;keyFrame&gt;::iterator itKF;</span>
        std::map&lt;int,keyFrame&gt;::iterator itKF;
        <span class="keywordflow">for</span>(itKF = storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.begin(); itKF != storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>.end(); ++itKF) {
                storage-&gt;<a class="code" href="classCentralStorage.html#ab3aae9d93bbccd2a646330cb8812824f">testBOWDescriptors_allRobots</a>.push_back((*itKF).second.bowDescriptor);
        }

}
</pre></div>
</div>
</div>
<a class="anchor" id="a9665aef254686f428f555d32c1b30fa8"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperPublishAssembledGlobalPtCl" ref="a9665aef254686f428f555d32c1b30fa8" args="(CentralStorage *storage, ros::Publisher &amp;pub, int skipFirstN)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a9665aef254686f428f555d32c1b30fa8">helperPublishAssembledGlobalPtCl</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ros::Publisher &amp;&#160;</td>
          <td class="paramname"><em>pub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>skipFirstN</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00110">110</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                    {

        <span class="comment">//vector&lt;int&gt; rIDToUpdate;</span>
        <span class="comment">//typedef std::map&lt;int,bool&gt; ptClUpdatedMap;</span>
        <span class="comment">//for (ptClUpdatedMap::iterator it = storage-&gt;ptClsInGlobalWorldCOSUpdated.begin(); it!=storage-&gt;ptClsInGlobalWorldCOSUpdated.end(); ++it) {</span>
        <span class="comment">//      if(it-&gt;second == true) {</span>
        <span class="comment">//              rIDToUpdate.push_back(it-&gt;first);</span>
        <span class="comment">//      }</span>
        <span class="comment">//}</span>

        <span class="comment">//if(!rIDToUpdate.empty()) {</span>
        <span class="comment">//      cout &lt;&lt; &quot;Not all PtCls up-to-date - no visualization&quot; &lt;&lt; endl;</span>
        <span class="comment">//}</span>
        <span class="comment">//else {</span>
        cout &lt;&lt; <span class="stringliteral">&quot;       Publishing assembled global PtCl&quot;</span> &lt;&lt; endl;

                pcl::PointCloud&lt;pcl::PointXYZ&gt; assembledGlobalPtCl;
                std::map&lt;int,int&gt; skipCtr;
                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1; i&lt;=storage-&gt;<a class="code" href="classCentralStorage.html#a83a67f52de30d339d872138243d42764">nbrRobots</a>; ++i) {
                        skipCtr[i] = 0;
                }
                <span class="keyword">typedef</span> std::map&lt;int,std::pair &lt;int,pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; &gt; ptClMap;
                <span class="keywordflow">for</span> (ptClMap::iterator it = storage-&gt;<a class="code" href="classCentralStorage.html#ac162077a92cd58a58d19ae7404719490">ptClsInGlobalWorldCOS</a>.begin(); it!=storage-&gt;<a class="code" href="classCentralStorage.html#ac162077a92cd58a58d19ae7404719490">ptClsInGlobalWorldCOS</a>.end(); ++it) {
                        <span class="keywordtype">bool</span> lessThanN = <span class="keyword">false</span>;
                        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=1; i&lt;=storage-&gt;<a class="code" href="classCentralStorage.html#a83a67f52de30d339d872138243d42764">nbrRobots</a>; ++i) {
                                <span class="keywordflow">if</span>(skipCtr[i] &lt; skipFirstN) {
                                        lessThanN = <span class="keyword">true</span>;
                                }
                        }
                        <span class="keywordflow">if</span>(lessThanN == <span class="keyword">false</span>) {
                                assembledGlobalPtCl += it-&gt;second.second;
                        }
                        skipCtr[it-&gt;second.first] = skipCtr[it-&gt;second.first]+1;
                }
                cout &lt;&lt; <span class="stringliteral">&quot;globptcl: &quot;</span> &lt;&lt; assembledGlobalPtCl.width &lt;&lt; endl;
                assembledGlobalPtCl.header.frame_id = <span class="stringliteral">&quot;world&quot;</span>;
                assembledGlobalPtCl.header.stamp = 0;
                pub.publish(assembledGlobalPtCl);
        <span class="comment">//}</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a085df1b3fc0cf52d21284c92297e891c"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperPublishAssembledLocalPtCl" ref="a085df1b3fc0cf52d21284c92297e891c" args="(CentralStorage *storage, int rID, ros::Publisher &amp;pub, int skipFirstN)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a085df1b3fc0cf52d21284c92297e891c">helperPublishAssembledLocalPtCl</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>rID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ros::Publisher &amp;&#160;</td>
          <td class="paramname"><em>pub</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>skipFirstN</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00151">151</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                            {

        <span class="comment">//if(storage-&gt;ptClsInGlobalWorldCOSUpdated[rID] == false) {</span>
        <span class="comment">//      cout &lt;&lt; &quot;PtCl of robot &quot; &lt;&lt; rID &lt;&lt; &quot; up-to-date - no visualization&quot; &lt;&lt; endl;</span>
        <span class="comment">//}</span>
        <span class="comment">//else {</span>
                cout &lt;&lt; <span class="stringliteral">&quot;       Publishing assembled local PtCl of Robot with robot ID: &quot;</span> &lt;&lt; rID &lt;&lt; endl;

                pcl::PointCloud&lt;pcl::PointXYZ&gt; assembledLocalPtCl;<span class="comment">// (new pcl::PointCloud&lt;pcl::PointXYZ&gt;());</span>

                <span class="keywordtype">int</span> skipCtr = 0;
                <span class="keyword">typedef</span> std::map&lt;int,std::pair &lt;int,pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; &gt; ptClMap;
                <span class="keywordflow">for</span> (ptClMap::iterator it = storage-&gt;<a class="code" href="classCentralStorage.html#ac162077a92cd58a58d19ae7404719490">ptClsInGlobalWorldCOS</a>.begin(); it!=storage-&gt;<a class="code" href="classCentralStorage.html#ac162077a92cd58a58d19ae7404719490">ptClsInGlobalWorldCOS</a>.end(); ++it) {
                        <span class="keywordflow">if</span>( (it-&gt;second.first == rID) ) {
                                <span class="keywordflow">if</span>(skipCtr&gt;=skipFirstN) {
                                        assembledLocalPtCl += it-&gt;second.second;
                                }
                        }
                        skipCtr = skipCtr+1;
                }
                assembledLocalPtCl.header.frame_id = <span class="stringliteral">&quot;world&quot;</span>;
                assembledLocalPtCl.header.stamp = 0;
                pub.publish(assembledLocalPtCl);
        <span class="comment">//}</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa9b6e90f43cc74d5b9e6a0d4d4304eef"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperPublishPtCl" ref="aa9b6e90f43cc74d5b9e6a0d4d4304eef" args="(pcl::PointCloud&lt; pcl::PointXYZ &gt; ptCl, ros::Publisher &amp;pub)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#aa9b6e90f43cc74d5b9e6a0d4d4304eef">helperPublishPtCl</a> </td>
          <td>(</td>
          <td class="paramtype">pcl::PointCloud&lt; pcl::PointXYZ &gt;&#160;</td>
          <td class="paramname"><em>ptCl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ros::Publisher &amp;&#160;</td>
          <td class="paramname"><em>pub</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00177">177</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                            {
        pcl::PointCloud&lt;pcl::PointXYZ&gt; ptClToPublish;
        ptClToPublish = ptCl;

        ptClToPublish.header.frame_id = <span class="stringliteral">&quot;world&quot;</span>;
        ptClToPublish.header.stamp = 0;

        pub.publish(ptClToPublish);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2a2548ab36e98be49fd91e373ee89684"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperReadTrainData" ref="a2a2548ab36e98be49fd91e373ee89684" args="(CentralStorage *storage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a2a2548ab36e98be49fd91e373ee89684">helperReadTrainData</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00187">187</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                  {

<span class="comment">/*</span>
<span class="comment">        // load training Images</span>
<span class="comment">//      fs.open(string(&quot;trainImgs_allRobots.yml&quot;), FileStorage::READ);</span>
<span class="comment">//      fs[&quot;trainImgs_allRobots&quot;] &gt;&gt; storage-&gt;trainImgs_allRobots;</span>
<span class="comment">//      if (storage-&gt;trainImgs_allRobots.empty()) {</span>
<span class="comment">//              cerr &lt;&lt; &quot;trainImgs_allRobots not found&quot; &lt;&lt; endl;</span>
<span class="comment">//              return -1;</span>
<span class="comment">//      }</span>
<span class="comment">//      fs.release();</span>
<span class="comment"></span>
<span class="comment">        // load training KeyPoints</span>
<span class="comment">//      fs.open(string(&quot;trainKPts_allRobots.yml&quot;), FileStorage::READ);</span>
<span class="comment">//      fs[&quot;trainKPts_allRobots&quot;] &gt;&gt; storage-&gt;trainKPts_allRobots;</span>
<span class="comment">//      if (storage-&gt;trainKPts_allRobots.empty()) {</span>
<span class="comment">//              cerr &lt;&lt; &quot;trainKPts_allRobots not found&quot; &lt;&lt; endl;</span>
<span class="comment">//              return -1;</span>
<span class="comment">//      }</span>
<span class="comment">//      fs.release();</span>
<span class="comment"></span>
<span class="comment">        // load SURF descriptors of training data</span>
<span class="comment">//      fs.open(string(&quot;trainDescriptors_allRobots.yml&quot;), FileStorage::READ);</span>
<span class="comment">//      fs[&quot;trainDescriptors_allRobots&quot;] &gt;&gt; storage-&gt;trainDescriptors_allRobots;</span>
<span class="comment">//      if (storage-&gt;trainDescriptors_allRobots.empty()) {</span>
<span class="comment">//              cerr &lt;&lt; &quot;Training Data SURF Descriptors not found&quot; &lt;&lt; endl;</span>
<span class="comment">//              return -1;</span>
<span class="comment">//      }</span>
<span class="comment">//      fs.release();</span>
<span class="comment">*/</span>

        FileStorage fs;

        <span class="comment">// load vocabulary</span>
        fs.open(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;vocabulary.yml&quot;</span>), FileStorage::READ);
        fs[<span class="stringliteral">&quot;vocabulary&quot;</span>] &gt;&gt; storage-&gt;<a class="code" href="classCentralStorage.html#a50f04d43d8c1f26725bb2e2e560a494c">vocabulary</a>;
        <span class="keywordflow">if</span> (storage-&gt;<a class="code" href="classCentralStorage.html#a50f04d43d8c1f26725bb2e2e560a494c">vocabulary</a>.empty()) {
                cerr &lt;&lt; <span class="stringliteral">&quot;Vocabulary not found&quot;</span> &lt;&lt; endl;
<span class="comment">//              return -1;</span>
        }
        fs.release();

        <span class="comment">// load trainBOWDescriptors_allRobots</span>
        fs.open(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;trainBOWDescriptors_allRobots.yml&quot;</span>), FileStorage::READ);
        fs[<span class="stringliteral">&quot;trainBOWDescriptors_allRobots&quot;</span>] &gt;&gt; storage-&gt;<a class="code" href="classCentralStorage.html#ad22679ec76d8fc9c99226a1bfdd4c410">trainBOWDescriptors_allRobots</a>;
        <span class="keywordflow">if</span> (storage-&gt;<a class="code" href="classCentralStorage.html#ad22679ec76d8fc9c99226a1bfdd4c410">trainBOWDescriptors_allRobots</a>.empty()) {
                cerr &lt;&lt; <span class="stringliteral">&quot;trainBOWDescriptors_allRobots not found&quot;</span> &lt;&lt; endl;
<span class="comment">//              return -1;</span>
        }
        fs.release();

        <span class="comment">// load clTree</span>
        fs.open(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;clTree.yml&quot;</span>), FileStorage::READ);
        fs[<span class="stringliteral">&quot;clTree&quot;</span>] &gt;&gt; storage-&gt;<a class="code" href="classCentralStorage.html#a5d9e98c4102f50187f6a034a99ef9793">clTree</a>;
        <span class="keywordflow">if</span> (storage-&gt;<a class="code" href="classCentralStorage.html#a5d9e98c4102f50187f6a034a99ef9793">clTree</a>.empty()) {
                cerr &lt;&lt; <span class="stringliteral">&quot;clTree not found&quot;</span> &lt;&lt; endl;
<span class="comment">//              return -1;</span>
        }
        fs.release();
}
</pre></div>
</div>
</div>
<a class="anchor" id="a8254506cb42ab9e85d3123dbbea7ce49"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperSaveTestImgs" ref="a8254506cb42ab9e85d3123dbbea7ce49" args="(CentralStorage *storage, SyncListener &amp;listener_r1, SyncListener &amp;listener_r2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a8254506cb42ab9e85d3123dbbea7ce49">helperSaveTestImgs</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classSyncListener.html">SyncListener</a> &amp;&#160;</td>
          <td class="paramname"><em>listener_r1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classSyncListener.html">SyncListener</a> &amp;&#160;</td>
          <td class="paramname"><em>listener_r2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00248">248</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                         {
        <span class="comment">// NO IMPLEMENTATION YET</span>
}
</pre></div>
</div>
</div>
<a class="anchor" id="a060e73dd74d1e5d07b42755cd9ffb1e2"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperSaveTrainData" ref="a060e73dd74d1e5d07b42755cd9ffb1e2" args="(CentralStorage *storage)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#a060e73dd74d1e5d07b42755cd9ffb1e2">helperSaveTrainData</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00252">252</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                  {

        FileStorage fs1(<span class="stringliteral">&quot;vocabulary.yml&quot;</span>, FileStorage::WRITE);
        fs1 &lt;&lt; <span class="stringliteral">&quot;vocabulary&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#a50f04d43d8c1f26725bb2e2e560a494c">vocabulary</a>;
        fs1.release();

        FileStorage fs2(<span class="stringliteral">&quot;trainBOWDescriptors_allRobots.yml&quot;</span>, FileStorage::WRITE);
        fs2 &lt;&lt; <span class="stringliteral">&quot;trainBOWDescriptors_allRobots&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ad22679ec76d8fc9c99226a1bfdd4c410">trainBOWDescriptors_allRobots</a>;
        fs2.release();

        FileStorage fs3(<span class="stringliteral">&quot;clTree.yml&quot;</span>, FileStorage::WRITE);
        fs3 &lt;&lt; <span class="stringliteral">&quot;clTree&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#a5d9e98c4102f50187f6a034a99ef9793">clTree</a>;
        fs3.release();

}
</pre></div>
</div>
</div>
<a class="anchor" id="af41fb2ed487a54eae76961955d42190b"></a><!-- doxytag: member="cc_fabmap_node.cpp::helperStoreTrainData" ref="af41fb2ed487a54eae76961955d42190b" args="(CentralStorage *storage, KeyFrameListenerTraining &amp;listenerR1, KeyFrameListenerTraining &amp;listenerR2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="cc__fabmap__node_8cpp.html#af41fb2ed487a54eae76961955d42190b">helperStoreTrainData</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classCentralStorage.html">CentralStorage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classKeyFrameListenerTraining.html">KeyFrameListenerTraining</a> &amp;&#160;</td>
          <td class="paramname"><em>listenerR1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classKeyFrameListenerTraining.html">KeyFrameListenerTraining</a> &amp;&#160;</td>
          <td class="paramname"><em>listenerR2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00268">268</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                                                 {

        storage-&gt;<a class="code" href="classCentralStorage.html#ad574732df5058d95d650c1187a9ba4f6">trainDescriptors_allRobots</a>.push_back(listenerR1.<a class="code" href="classKeyFrameListenerTraining.html#a2db812cb925b74093ef76bc16306d9d7" title="all SIFT/SURF descrs. of all trainImgs of 1 robot">m_trainImgDescr</a>);
        storage-&gt;<a class="code" href="classCentralStorage.html#ad574732df5058d95d650c1187a9ba4f6">trainDescriptors_allRobots</a>.push_back(listenerR2.<a class="code" href="classKeyFrameListenerTraining.html#a2db812cb925b74093ef76bc16306d9d7" title="all SIFT/SURF descrs. of all trainImgs of 1 robot">m_trainImgDescr</a>);

        std::vector&lt;cv::Mat&gt;::iterator itImg1;
        <span class="keywordflow">for</span>(itImg1 = listenerR1.<a class="code" href="classKeyFrameListenerTraining.html#a48bd94c8aaabd896a16fd7bb1557e0e7" title="Mat: trainImg, vec&lt;Mat&gt;: all trainImgs of 1robot.">m_trainImgs</a>.begin(); itImg1 != listenerR1.<a class="code" href="classKeyFrameListenerTraining.html#a48bd94c8aaabd896a16fd7bb1557e0e7" title="Mat: trainImg, vec&lt;Mat&gt;: all trainImgs of 1robot.">m_trainImgs</a>.end(); ++itImg1) {
                storage-&gt;<a class="code" href="classCentralStorage.html#a673208fa43bab02c4e53077ae45a38e7">trainImgs_allRobots</a>.push_back(*itImg1);
        }
        std::vector&lt;cv::Mat&gt;::iterator itImg2;
        <span class="keywordflow">for</span>(itImg2 = listenerR2.<a class="code" href="classKeyFrameListenerTraining.html#a48bd94c8aaabd896a16fd7bb1557e0e7" title="Mat: trainImg, vec&lt;Mat&gt;: all trainImgs of 1robot.">m_trainImgs</a>.begin(); itImg2 != listenerR2.<a class="code" href="classKeyFrameListenerTraining.html#a48bd94c8aaabd896a16fd7bb1557e0e7" title="Mat: trainImg, vec&lt;Mat&gt;: all trainImgs of 1robot.">m_trainImgs</a>.end(); ++itImg2) {
                storage-&gt;<a class="code" href="classCentralStorage.html#a673208fa43bab02c4e53077ae45a38e7">trainImgs_allRobots</a>.push_back(*itImg2);
        }


        std::vector&lt;vector&lt;KeyPoint&gt; &gt;::iterator itKPts1;
        <span class="keywordflow">for</span>(itKPts1 = listenerR1.<a class="code" href="classKeyFrameListenerTraining.html#a315dd8f41de6cf586c90f600650a908d" title="vec&lt;KPts&gt;: all kpts from 1 trainImg of 1 robot, vec&lt;vec&lt;KPt&gt;&gt;: all KPts from all trainImgs from 1 rob...">m_trainKPts</a>.begin(); itKPts1 != listenerR1.<a class="code" href="classKeyFrameListenerTraining.html#a315dd8f41de6cf586c90f600650a908d" title="vec&lt;KPts&gt;: all kpts from 1 trainImg of 1 robot, vec&lt;vec&lt;KPt&gt;&gt;: all KPts from all trainImgs from 1 rob...">m_trainKPts</a>.end(); ++itKPts1) {
                storage-&gt;<a class="code" href="classCentralStorage.html#a6eba28072f558f36c2b3a08170f9db74">trainKPts_allRobots</a>.push_back(*itKPts1);
        }
        std::vector&lt;vector&lt;KeyPoint&gt; &gt;::iterator itKPts2;
        <span class="keywordflow">for</span>(itKPts2 = listenerR2.<a class="code" href="classKeyFrameListenerTraining.html#a315dd8f41de6cf586c90f600650a908d" title="vec&lt;KPts&gt;: all kpts from 1 trainImg of 1 robot, vec&lt;vec&lt;KPt&gt;&gt;: all KPts from all trainImgs from 1 rob...">m_trainKPts</a>.begin(); itKPts2 != listenerR2.<a class="code" href="classKeyFrameListenerTraining.html#a315dd8f41de6cf586c90f600650a908d" title="vec&lt;KPts&gt;: all kpts from 1 trainImg of 1 robot, vec&lt;vec&lt;KPt&gt;&gt;: all KPts from all trainImgs from 1 rob...">m_trainKPts</a>.end(); ++itKPts2) {
                storage-&gt;<a class="code" href="classCentralStorage.html#a6eba28072f558f36c2b3a08170f9db74">trainKPts_allRobots</a>.push_back(*itKPts2);
        }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a><!-- doxytag: member="cc_fabmap_node.cpp::main" ref="a3c04138a5bfe5d72780bb7e82a18e627" args="(int argc, char **argv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="cc__fabmap__node_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>---- INITIALIZE ---------------------------------------------------------</p>
<p>---------------------------------------- ----------------------------------------</p>
<p>TRAINING -------------------------------</p>
<p>---------------------------------------- ----------------------------------------</p>
<p>---- Generate vocabulary (visual words) ---------------------------------------------------------</p>
<p>---------------------------------------- ----------------------------------------</p>
<p>TESTING --------------------------------</p>
<p>---------------------------------------- ---------------------------------------- </p>

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00306">306</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>
<div class="fragment"><pre class="fragment">                                {
        system(<span class="stringliteral">&quot;exec rm -r /home/daniel/ROS_HKUST_project/CCFabMap_catkin_ws/testImgs/*&quot;</span>);
        system(<span class="stringliteral">&quot;exec rm -r /home/daniel/ROS_HKUST_project/CCFabMap_catkin_ws/matchingImgs/*&quot;</span>);
        initModule_nonfree();

        <span class="keywordtype">bool</span> doTraining = <span class="keyword">false</span>; <span class="comment">// enable training (vocabulary, chow-liu tree, create file with training data BOW Img descriptors)</span>
        <span class="keywordtype">bool</span> doTesting = <span class="keyword">true</span>; <span class="comment">// enable testing (gathering ptcls and check for loop closures between different robots and loop closures concerning one robot</span>
        <span class="keywordtype">bool</span> boolSaveTestImgs = <span class="keyword">true</span>; <span class="comment">// enable to save the received keyframes</span>
        <span class="keywordtype">bool</span> boolNewKF = <span class="keyword">false</span>; <span class="comment">// will be set to true whenever a new keyframe with enough information (enough keypoints) was sent to central computer</span>
        <span class="keywordtype">bool</span> boolEndAfterFound1Match = <span class="keyword">false</span>; <span class="comment">// enable to stop looking for further loop closures after the first match - just for verification of the code</span>
        <span class="keywordtype">bool</span> boolVisualizePtCl = <span class="keyword">true</span>; <span class="comment">// enable to visualize the local ptcls of the different robots in RVIZ</span>
        <span class="keywordtype">bool</span> boolVisualizedOnce = <span class="keyword">false</span>;
        <span class="keywordtype">int</span> nbrRobots = 2; <span class="comment">// Number of robots in the system - aim to be set during runtime</span>
        <span class="keywordtype">int</span> nbrVisWords = 700;
        <span class="keywordtype">int</span> nbrTrainImgs = 1500;

        ros::init(argc, argv, <span class="stringliteral">&quot;cc_fabmap&quot;</span>);
        ros::NodeHandle nh;

        <a class="code" href="classCentralStorage.html" title="Class storing all images of all robots, global maps (pose graph and point cloud)">CentralStorage</a>* storage = <span class="keyword">new</span> <a class="code" href="classCentralStorage.html" title="Class storing all images of all robots, global maps (pose graph and point cloud)">CentralStorage</a>(nbrRobots, nbrVisWords);



        <span class="keywordflow">if</span>(doTraining) {

                <a class="code" href="classKeyFrameListenerTraining.html" title="Class listening to incoming images, each instance of the class listens to one robot -&gt; do training...">KeyFrameListenerTraining</a> kFListenerTrainingR1(1, nbrTrainImgs, <span class="stringliteral">&quot;/usb_cam_training/image_rect&quot;</span>, nh, storage);
                <a class="code" href="classKeyFrameListenerTraining.html" title="Class listening to incoming images, each instance of the class listens to one robot -&gt; do training...">KeyFrameListenerTraining</a> kFListenerTrainingR2(2, nbrTrainImgs, <span class="stringliteral">&quot;/usb_cam_training_robot2/image_raw&quot;</span>, nh, storage);

                <span class="comment">// spinning</span>
                cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;TRAINING --------------------------------&quot;</span> &lt;&lt; endl;


                ros::Rate rTrain(20);
                <span class="keywordflow">while</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ac721895aafa60a4fb37c9659aabaed7a">stopDataCollection</a>==<span class="keyword">false</span> &amp;&amp; ros::ok())
                {
                        ros::spinOnce();
                        rTrain.sleep();
                }


                <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#ac721895aafa60a4fb37c9659aabaed7a">stopDataCollection</a>==<span class="keyword">true</span>)
                {
                        cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;store all Training Data in instance of CentralStorage&quot;</span> &lt;&lt; endl;
                        <a class="code" href="cc__fabmap__node_8cpp.html#af41fb2ed487a54eae76961955d42190b">helperStoreTrainData</a>(storage, kFListenerTrainingR1, kFListenerTrainingR2);

                        cout &lt;&lt; <span class="stringliteral">&quot;Generate Vocabulary&quot;</span> &lt;&lt; endl;
                        storage-&gt;<a class="code" href="classCentralStorage.html#aed7b4357ce0cb743a5c8074b805b51a5" title="Member function generating vocabulatory (dictionary/ visual words/ ...) and outputting it in &quot;vocab...">generateVocabulary</a>();
        
                        cout &lt;&lt; <span class="stringliteral">&quot;Set Vocabulary for BOW Descriptor extractor&quot;</span> &lt;&lt; endl;
                        (storage-&gt;<a class="code" href="classCentralStorage.html#ab1828f1368902fab93265328a6e53063">bide</a>)-&gt;setVocabulary(storage-&gt;<a class="code" href="classCentralStorage.html#a50f04d43d8c1f26725bb2e2e560a494c">vocabulary</a>);

                        cout &lt;&lt; <span class="stringliteral">&quot;Compute BOW Descriptors for Training Images&quot;</span> &lt;&lt; endl;
                        storage-&gt;<a class="code" href="classCentralStorage.html#a925c5d072478a869cc511e11cbe9248d">computeTrainBOWDescriptors</a>();

                        cout &lt;&lt; <span class="stringliteral">&quot;Compute Chow Liu Tree based on Training Data&quot;</span> &lt;&lt; endl;
                        storage-&gt;<a class="code" href="classCentralStorage.html#a76ea5d6aa74f139a4db824b679958ce2" title="Member function generating chow liu tree and outputting it in &quot;cltree.yml&quot;.">generateCLTree</a>();

                        cout &lt;&lt; <span class="stringliteral">&quot;save all necessary Training Data on harddisk&quot;</span> &lt;&lt; endl;
                        <a class="code" href="cc__fabmap__node_8cpp.html#a060e73dd74d1e5d07b42755cd9ffb1e2">helperSaveTrainData</a>(storage);

                        cout &lt;&lt; <span class="stringliteral">&quot;Initialize FabMap instance&quot;</span> &lt;&lt; endl &lt;&lt; endl;
                        storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a> = <span class="keyword">new</span> of2::FabMap2(storage-&gt;<a class="code" href="classCentralStorage.html#a5d9e98c4102f50187f6a034a99ef9793">clTree</a>, 0.2, 0, of2::FabMap::SAMPLED | of2::FabMap::CHOW_LIU);
                        storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a>-&gt;addTraining(storage-&gt;<a class="code" href="classCentralStorage.html#ad22679ec76d8fc9c99226a1bfdd4c410">trainBOWDescriptors_allRobots</a>);
                }
        }
        <span class="keywordflow">else</span> {
                storage-&gt;<a class="code" href="classCentralStorage.html#ac721895aafa60a4fb37c9659aabaed7a">stopDataCollection</a> = <span class="keyword">true</span>;

                <a class="code" href="cc__fabmap__node_8cpp.html#a2a2548ab36e98be49fd91e373ee89684">helperReadTrainData</a>(storage);

                cout &lt;&lt; <span class="stringliteral">&quot;Set Vocabulary for BOW Descriptor extractor&quot;</span> &lt;&lt; endl;
                (storage-&gt;<a class="code" href="classCentralStorage.html#ab1828f1368902fab93265328a6e53063">bide</a>)-&gt;setVocabulary(storage-&gt;<a class="code" href="classCentralStorage.html#a50f04d43d8c1f26725bb2e2e560a494c">vocabulary</a>);

                cout &lt;&lt; <span class="stringliteral">&quot;Initialize FabMap instance&quot;</span> &lt;&lt; endl &lt;&lt; endl;
                storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a> = <span class="keyword">new</span> of2::FabMap2(storage-&gt;<a class="code" href="classCentralStorage.html#a5d9e98c4102f50187f6a034a99ef9793">clTree</a>, 0.4, 0, of2::FabMap::SAMPLED | of2::FabMap::CHOW_LIU);
                storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a>-&gt;addTraining(storage-&gt;<a class="code" href="classCentralStorage.html#ad22679ec76d8fc9c99226a1bfdd4c410">trainBOWDescriptors_allRobots</a>);

        }
        cout &lt;&lt; <span class="stringliteral">&quot;TRAINING OR LOADING finished --------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl;


        


        <span class="keywordflow">if</span>(doTesting) {

                cout &lt;&lt; <span class="stringliteral">&quot;Initialize synchronized ROS topic listener&quot;</span> &lt;&lt; endl;
                <a class="code" href="classSyncListener.html" title="Class listening to incoming Msgs and synchronizes them, each instance of the class listens to one rob...">SyncListener</a> syncListenerR1(1, <span class="stringliteral">&quot;/usb_cam_r1/camera_info&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot1/pointcloud2Filtered&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot1/kFMsgStamped&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot1/kFGraphMsgStamped&quot;</span>,
                                nh, storage);
                <a class="code" href="classSyncListener.html" title="Class listening to incoming Msgs and synchronizes them, each instance of the class listens to one rob...">SyncListener</a> syncListenerR2(2, <span class="stringliteral">&quot;/usb_cam_r2/camera_info&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot2/pointcloud2Filtered&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot2/kFMsgStamped&quot;</span>,
                                <span class="stringliteral">&quot;/slave_robot2/kFGraphMsgStamped&quot;</span>,
                                nh, storage);





                <span class="comment">// ONLY FOR CHECKING IN RVIZ (RUN RVIZ IN GDB MODE IF rosrun rviz rviz does not work: gdb /opt/ros/hydro/lib/rviz/rviz)</span>
                ros::Publisher pub1 = nh.advertise&lt; pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; (<span class="stringliteral">&quot;ptClCheck1&quot;</span>, 1);
                ros::Publisher pub2 = nh.advertise&lt; pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; (<span class="stringliteral">&quot;ptClCheck2&quot;</span>, 1);
                ros::Publisher pub3 = nh.advertise&lt; pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; (<span class="stringliteral">&quot;ptClCheck3&quot;</span>, 1);
                ros::Publisher pub4 = nh.advertise&lt; pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; (<span class="stringliteral">&quot;ptClCheck4&quot;</span>, 1);
                ros::Publisher pub5 = nh.advertise&lt; pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; (<span class="stringliteral">&quot;ptClCheck5&quot;</span>, 1);
                <span class="keyword">static</span> tf::TransformBroadcaster br1, br2, br3, br4;
                tf::Transform trafoROSMsgR1,trafoROSMsgR2,
                        trafoROSMsgR1C1, trafoROSMsgC1R1,
                        trafoROSMsgR2C2, trafoROSMsgC2R2, trafoROSMsgR2FromSyncListener,
                        trafoROSMsgC2C1, trafoROSMsgC1C2;
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgR1);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgR2);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgR1C1);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgC1R1);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgR2C2);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgC2R2);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgC2C1);
                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(Eigen::Matrix4f::Identity(4,4), trafoROSMsgC1C2);
                <span class="comment">// END ONLY FOR CHECKING IN RVIZ --------------------------------------</span>

                <span class="comment">// string variables to save imgs, files</span>
                ostringstream convImgName, convMatchMatrixNameImg, convMatchMatrixNameFile;
                <span class="keywordtype">string</span> imgName, matchMatrixNameImg, matchMatrixNameFile;

                cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;TESTING --------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl;
                ros::Rate rTest(5); <span class="comment">// adequate spinning frequency???</span>

                <span class="keywordflow">while</span>(ros::ok() &amp;&amp; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt; 2000)
                {

                        ros::spinOnce();

                        <span class="comment">// Robot 1 received a nonempty keyframe with enough keypts</span>
                        <span class="keywordflow">if</span>(!syncListenerR1.m_kFrame.img.empty() &amp;&amp; syncListenerR1.m_kFrame.KPts.size()&gt;=15 ) {

                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;ROBOT 1 has received a keyframe&quot;</span> &lt;&lt; endl;
                                <span class="keywordflow">if</span>(boolSaveTestImgs) {
                                        <span class="comment">// Defining strings to save imgs, files, ...</span>
                                        convImgName.clear(); convImgName.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convMatchMatrixNameImg.clear(); convMatchMatrixNameImg.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convMatchMatrixNameFile.clear(); convMatchMatrixNameFile.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convImgName &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR1.m_rID &lt;&lt; <span class="stringliteral">&quot;TestImg&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.jpg&quot;</span>;
                                        convMatchMatrixNameImg &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR1.m_rID &lt;&lt; <span class="stringliteral">&quot;MatchMatrix&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.jpg&quot;</span>;
                                        convMatchMatrixNameFile &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR1.m_rID &lt;&lt; <span class="stringliteral">&quot;MatchMatrix&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.yml&quot;</span>;
                                        imgName = convImgName.str();
                                        matchMatrixNameImg = convMatchMatrixNameImg.str();
                                        matchMatrixNameFile = convMatchMatrixNameFile.str();
                                        <a class="code" href="classHelperFcts.html#a62a2cbe4631785fe2e85c9131153d8f6">HelperFcts::saveImage</a>(syncListenerR1.m_kFrame.img, imgName);
                                }


                                <span class="comment">// Compute BOW descriptor of current query image</span>
                                syncListenerR1.m_kFrame.fID = storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>;
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab1828f1368902fab93265328a6e53063">bide</a>-&gt;compute(syncListenerR1.m_kFrame.img, syncListenerR1.m_kFrame.KPts, syncListenerR1.m_kFrame.bowDescriptor);

                                <span class="comment">// Add Keyframe to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = syncListenerR1.m_kFrame;

                                <span class="comment">// Add ptcl to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#a98df05b89e7956601eeff266fbef0754" title="the key for accessing a ptCls corresponds to the the kFrames identity number (ImgCtr), the std::pair contains the associated rID and the actual PtCl">ptCls</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair( syncListenerR1.m_rID, *(syncListenerR1.m_localPtCl) );
                                syncListenerR1.m_localPtCl-&gt;clear();

                                <span class="comment">// Add keyframe pose in initial robot COS to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#a9f86101c4abfa538b14ecafbbffb49e8">localPoses</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair(syncListenerR1.m_rID,syncListenerR1.m_localPose);
                                storage-&gt;<a class="code" href="classCentralStorage.html#a77f707a32dbf4d3b76668d2bdb2db060" title="Saves the scales for all robots and all images. IMPORTANT NOTE: only the latest scale is needed for e...">localScales</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair(syncListenerR1.m_rID,syncListenerR1.m_sim3LocalPoseScale);

                                <span class="comment">// RUN FABMAP ROBOT 1</span>
                                cout &lt;&lt; <span class="stringliteral">&quot;       Run FABMAP&quot;</span> &lt;&lt; endl;
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab3aae9d93bbccd2a646330cb8812824f">testBOWDescriptors_allRobots</a>.push_back(syncListenerR1.m_kFrame.bowDescriptor);
                                storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a>-&gt;compare(syncListenerR1.m_kFrame.bowDescriptor, storage-&gt;<a class="code" href="classCentralStorage.html#af2ce7451320774bb90db744fa46493bd">matches</a>, <span class="keyword">true</span>);

                                <span class="keywordflow">if</span>(!boolEndAfterFound1Match) {

                                        <span class="comment">// SEARCH FOR BEST MATCH</span>
                                        storage-&gt;<a class="code" href="classCentralStorage.html#a7e6a32a86c37de7871884670cf97d598">searchForGoodMatch</a>();
                                        <span class="comment">// Compute transformation between matched Images and subsequently between PtCls</span>
                                        <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#a311e52441ce3ca79a2eac623c58221cc">boolMatch</a> == <span class="keyword">true</span>) {
                                                cout &lt;&lt; <span class="stringliteral">&quot;       Robot1 found a loop-closure&quot;</span> &lt;&lt; endl;

                                                <a class="code" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a>++;
                                                storage-&gt;<a class="code" href="classCentralStorage.html#a76c399f09dc7d0083508c1a14f8dd8f3" title="Member function calculating an initial guess for the pose of one camera relative to the other camera ...">findTrafoInitialGuess</a>();
                                                <span class="comment">//storage-&gt;findTrafo(storage-&gt;iGMap[storage-&gt;testImgCtr].first, storage-&gt;iGMap[storage-&gt;testImgCtr].first)</span>
                                                <span class="comment">//storage-&gt;estimateScale();</span>

                                                <span class="keywordflow">if</span>(<a class="code" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a> == 1) {
                                                        <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>( storage-&gt;<a class="code" href="classCentralStorage.html#a3ae59bfa3849b3dd984c636e0a9af23a">iGMap</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>].first, trafoROSMsgC2C1 );
                                                        boolEndAfterFound1Match = <span class="keyword">true</span>;
                                                }
                                                storage-&gt;<a class="code" href="classCentralStorage.html#a311e52441ce3ca79a2eac623c58221cc">boolMatch</a> = <span class="keyword">false</span>;
                                        }
                                }
                                storage-&gt;<a class="code" href="classCentralStorage.html#ad0e2f8a4581fe0e61a49b07141442dd2">updatePosesOfRobots</a>();
                                storage-&gt;<a class="code" href="classCentralStorage.html#ac065c164a68a24bb1d5e0ff0b9a41f84">updatePtCls</a>();

                                Eigen::Matrix4f pCam1Robot1(Eigen::Matrix4f::Identity(4,4)), pRobot1Cam1(Eigen::Matrix4f::Identity(4,4));
                                <a class="code" href="classHelperFcts.html#ad8c1a028f297ea395c9d8239f64a74e2">HelperFcts::poseStampedROSToMatrix4f</a>(storage-&gt;<a class="code" href="classCentralStorage.html#a9f86101c4abfa538b14ecafbbffb49e8">localPoses</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>].second, pCam1Robot1);
                                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(pCam1Robot1, trafoROSMsgC1R1);
                                br1.sendTransform(tf::StampedTransform( trafoROSMsgC1R1, ros::Time::now(), <span class="stringliteral">&quot;world&quot;</span>, <span class="stringliteral">&quot;cam1&quot;</span>) );


                                boolNewKF = <span class="keyword">true</span>;
                                storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> = storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> + 1;
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl &lt;&lt; endl;
                        }

                        <span class="comment">// Robot 2 received a nonempty keyframe with enough keypts</span>
                        <span class="keywordflow">if</span>(!syncListenerR2.m_kFrame.img.empty()  &amp;&amp; syncListenerR2.m_kFrame.KPts.size()&gt;=15 ) {

                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;ROBOT 2 has received a keyframe&quot;</span> &lt;&lt; endl;
                                <span class="keywordflow">if</span>(boolSaveTestImgs) {
                                        <span class="comment">// Defining strings to save imgs, files, ...</span>
                                        convImgName.clear(); convImgName.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convMatchMatrixNameImg.clear(); convMatchMatrixNameImg.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convMatchMatrixNameFile.clear(); convMatchMatrixNameFile.str(<span class="stringliteral">&quot;&quot;</span>);
                                        convImgName &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR2.m_rID &lt;&lt; <span class="stringliteral">&quot;TestImg&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.jpg&quot;</span>;
                                        convMatchMatrixNameImg &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR2.m_rID &lt;&lt; <span class="stringliteral">&quot;MatchMatrix&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.jpg&quot;</span>;
                                        convMatchMatrixNameFile &lt;&lt; <span class="stringliteral">&quot;testImgs/robot&quot;</span> &lt;&lt; syncListenerR2.m_rID &lt;&lt; <span class="stringliteral">&quot;MatchMatrix&quot;</span> &lt;&lt; storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> &lt;&lt; <span class="stringliteral">&quot;.yml&quot;</span>;
                                        imgName = convImgName.str();
                                        matchMatrixNameImg = convMatchMatrixNameImg.str();
                                        matchMatrixNameFile = convMatchMatrixNameFile.str();
                                        <a class="code" href="classHelperFcts.html#a62a2cbe4631785fe2e85c9131153d8f6">HelperFcts::saveImage</a>(syncListenerR2.m_kFrame.img, imgName);
                                }

                                <span class="comment">// Compute BOW descriptor of current query image</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab1828f1368902fab93265328a6e53063">bide</a>-&gt;compute( syncListenerR2.m_kFrame.img, syncListenerR2.m_kFrame.KPts, syncListenerR2.m_kFrame.bowDescriptor );
                                syncListenerR2.m_kFrame.fID = storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>;

                                <span class="comment">// Add keyframe to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab477c78726c58cba1b5b14255700ff64">kFrames</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = syncListenerR2.m_kFrame;
                                <span class="comment">// Add ptcl to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#a98df05b89e7956601eeff266fbef0754" title="the key for accessing a ptCls corresponds to the the kFrames identity number (ImgCtr), the std::pair contains the associated rID and the actual PtCl">ptCls</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair( syncListenerR2.m_rID, *(syncListenerR2.m_localPtCl) );
                                syncListenerR2.m_localPtCl-&gt;clear();

                                <span class="comment">// Add keyframe pose in initial robot COS to storage</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#a9f86101c4abfa538b14ecafbbffb49e8">localPoses</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair(syncListenerR2.m_rID,syncListenerR2.m_localPose);
                                storage-&gt;<a class="code" href="classCentralStorage.html#a77f707a32dbf4d3b76668d2bdb2db060" title="Saves the scales for all robots and all images. IMPORTANT NOTE: only the latest scale is needed for e...">localScales</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>] = std::make_pair(syncListenerR2.m_rID,syncListenerR2.m_sim3LocalPoseScale);

                                <span class="comment">// RUN FABMAP ROBOT 2</span>
                                cout &lt;&lt; <span class="stringliteral">&quot;       Run FABMAP&quot;</span> &lt;&lt; endl;
                                storage-&gt;<a class="code" href="classCentralStorage.html#ab3aae9d93bbccd2a646330cb8812824f">testBOWDescriptors_allRobots</a>.push_back(syncListenerR2.m_kFrame.bowDescriptor);
                                storage-&gt;<a class="code" href="classCentralStorage.html#a4172d4d2a8509cb0bfbdb4edc8a3707b">fabmap</a>-&gt;compare(syncListenerR2.m_kFrame.bowDescriptor, storage-&gt;<a class="code" href="classCentralStorage.html#af2ce7451320774bb90db744fa46493bd">matches</a>, <span class="keyword">true</span>);


                                <span class="keywordflow">if</span>(!boolEndAfterFound1Match) {

                                        <span class="comment">// SEARCH FOR GOOD MATCHES</span>
                                        storage-&gt;<a class="code" href="classCentralStorage.html#a7e6a32a86c37de7871884670cf97d598">searchForGoodMatch</a>(); <span class="comment">// if found a good match resulting from FABMAP storage-&gt;boolMatch will be set to true</span>

                                        <span class="keywordflow">if</span>(storage-&gt;<a class="code" href="classCentralStorage.html#a311e52441ce3ca79a2eac623c58221cc">boolMatch</a> == <span class="keyword">true</span>) {
                                                cout &lt;&lt; <span class="stringliteral">&quot;       Robot2 found a loop-closure&quot;</span> &lt;&lt; endl;
                                                <a class="code" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a>++;
                                                storage-&gt;<a class="code" href="classCentralStorage.html#a76c399f09dc7d0083508c1a14f8dd8f3" title="Member function calculating an initial guess for the pose of one camera relative to the other camera ...">findTrafoInitialGuess</a>();
                                                <span class="comment">//storage-&gt;findTrafo(storage-&gt;iGMap[storage-&gt;testImgCtr].first, storage-&gt;iGMap[storage-&gt;testImgCtr].first)</span>
                                                <span class="comment">//storage-&gt;estimateScale();</span>
                                                <span class="keywordflow">if</span>(<a class="code" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a> == 1) {
                                                        <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>( storage-&gt;<a class="code" href="classCentralStorage.html#a3ae59bfa3849b3dd984c636e0a9af23a">iGMap</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>].first, trafoROSMsgC1C2 );
                                                        boolEndAfterFound1Match = <span class="keyword">true</span>;
                                                }
                                                storage-&gt;<a class="code" href="classCentralStorage.html#a311e52441ce3ca79a2eac623c58221cc">boolMatch</a> = <span class="keyword">false</span>;
                                        }
                                }
                                <span class="comment">// Update Poses of robots and PtCls relative to global world COS</span>
                                storage-&gt;<a class="code" href="classCentralStorage.html#ad0e2f8a4581fe0e61a49b07141442dd2">updatePosesOfRobots</a>();
                                storage-&gt;<a class="code" href="classCentralStorage.html#ac065c164a68a24bb1d5e0ff0b9a41f84">updatePtCls</a>();

                                Eigen::Matrix4f pCam2Robot2(Eigen::Matrix4f::Identity(4,4)), pRobot2Cam2(Eigen::Matrix4f::Identity(4,4));
                                <a class="code" href="classHelperFcts.html#ad8c1a028f297ea395c9d8239f64a74e2">HelperFcts::poseStampedROSToMatrix4f</a>(storage-&gt;<a class="code" href="classCentralStorage.html#a9f86101c4abfa538b14ecafbbffb49e8">localPoses</a>[storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a>].second, pCam2Robot2);
                                <a class="code" href="classHelperFcts.html#aa8536f7744cd1ed6acba4fd7fe5fe8e8">HelperFcts::eigenMatrix4fToROSTrafoMsg</a>(pCam2Robot2, trafoROSMsgC2R2);
                                br2.sendTransform(tf::StampedTransform( trafoROSMsgC2R2, ros::Time::now(), <span class="stringliteral">&quot;world&quot;</span>, <span class="stringliteral">&quot;cam2&quot;</span>) );


                                boolNewKF = <span class="keyword">true</span>;
                                storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> = storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> + 1; <span class="comment">// testImgCtr contains nbr of testing Imgs + query Img</span>
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl &lt;&lt; endl;
                        }




                        <span class="comment">// visualize local ptcl</span>
                        <span class="keywordflow">if</span>(boolEndAfterFound1Match == <span class="keyword">true</span> &amp;&amp; boolVisualizePtCl == <span class="keyword">true</span> &amp;&amp; boolVisualizedOnce == <span class="keyword">false</span>) {
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl;
                                cout &lt;&lt; <span class="stringliteral">&quot;Visualize Local PtCl&quot;</span> &lt;&lt; endl;



                                pcl::PointCloud&lt;pcl::PointXYZ&gt; assembledLocalPtClUntransformed;<span class="comment">// (new pcl::PointCloud&lt;pcl::PointXYZ&gt;());</span>
                                <span class="keyword">typedef</span> std::map&lt;int,std::pair &lt;int,pcl::PointCloud&lt;pcl::PointXYZ&gt; &gt; &gt; ptClMap;
                                <span class="keywordflow">for</span> (ptClMap::iterator it = storage-&gt;<a class="code" href="classCentralStorage.html#a98df05b89e7956601eeff266fbef0754" title="the key for accessing a ptCls corresponds to the the kFrames identity number (ImgCtr), the std::pair contains the associated rID and the actual PtCl">ptCls</a>.begin(); it!=storage-&gt;<a class="code" href="classCentralStorage.html#a98df05b89e7956601eeff266fbef0754" title="the key for accessing a ptCls corresponds to the the kFrames identity number (ImgCtr), the std::pair contains the associated rID and the actual PtCl">ptCls</a>.end(); ++it) {
                                        <span class="keywordflow">if</span>( (it-&gt;second.first == 2) ) {
                                                assembledLocalPtClUntransformed += it-&gt;second.second;
                                        }
                                }

                                <a class="code" href="cc__fabmap__node_8cpp.html#aa9b6e90f43cc74d5b9e6a0d4d4304eef">helperPublishPtCl</a>(assembledLocalPtClUntransformed, pub3);
                                <a class="code" href="cc__fabmap__node_8cpp.html#a085df1b3fc0cf52d21284c92297e891c">helperPublishAssembledLocalPtCl</a>(storage, 2, pub2, 2);
                                <a class="code" href="cc__fabmap__node_8cpp.html#a085df1b3fc0cf52d21284c92297e891c">helperPublishAssembledLocalPtCl</a>(storage, 1, pub1, 4);
                                <a class="code" href="cc__fabmap__node_8cpp.html#a9665aef254686f428f555d32c1b30fa8">helperPublishAssembledGlobalPtCl</a>(storage, pub4, 3);

                                boolNewKF = <span class="keyword">false</span>;
                                boolVisualizedOnce = <span class="keyword">true</span>;
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl &lt;&lt; endl;
                        }

                        <span class="comment">// clear central storage</span>
                        <span class="keywordtype">bool</span> boolClear = <span class="keyword">false</span>;

                        <span class="keywordflow">if</span>( ( ((storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> % 60) == 0) || ((storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> % 60) == 1) ) &amp;&amp; boolClear == <span class="keyword">true</span> &amp;&amp; (storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> != 0) &amp;&amp; (storage-&gt;<a class="code" href="classCentralStorage.html#ac6ecd35e9f6a9d0145f87fb98c6fb923">testImgCtr</a> != 1) ) {
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl;
                                cout &lt;&lt; <span class="stringliteral">&quot;Clear Storage Data&quot;</span> &lt;&lt; endl;
                                storage-&gt;<a class="code" href="classCentralStorage.html#a90df91c64ab74dfa7d557f08a27a9cdf">clearData</a>();
                                cout &lt;&lt; <span class="stringliteral">&quot;---------------------------------------------&quot;</span> &lt;&lt; endl &lt;&lt; endl &lt;&lt; endl;
                        }


                        <span class="comment">//HelperFcts::poseROSToTrafoROSMsg( syncListenerR2.m_localPose.pose, trafoROSMsgR2FromSyncListener);</span>
                        <span class="comment">//helperPoseToROSTrafoMsg(syncListenerR2.m_localPose.pose,trafoROSMsgR2);</span>
                        <span class="comment">//br1.sendTransform(tf::StampedTransform( trafoROSMsgC2C1, ros::Time::now(), &quot;world&quot;, &quot;cam2&quot;) );</span>
                        <span class="comment">//br2.sendTransform(tf::StampedTransform( trafoROSMsgC1C2, ros::Time::now(), &quot;world&quot;, &quot;cam1&quot;) );</span>
                        <span class="comment">//br.sendTransform(tf::StampedTransform(trafoROSMsgR2FromSyncListener, ros::Time::now(), &quot;cam2&quot;, &quot;world&quot;));</span>

                        <span class="keywordflow">if</span>(!storage-&gt;<a class="code" href="classCentralStorage.html#ab3aae9d93bbccd2a646330cb8812824f">testBOWDescriptors_allRobots</a>.empty()) {
                                <a class="code" href="cc__fabmap__node_8cpp.html#a99cb8485ba55364caae90a9d3d8d6609">helperDispOutput</a>(storage, <span class="keyword">true</span>, <span class="stringliteral">&quot;testImgs/robot1MatchMatrixEnd.jpg&quot;</span>, <span class="stringliteral">&quot;testImgs/robot1MatchMatrixFileEnd.yml&quot;</span>);
                        }

                        boolNewKF = <span class="keyword">false</span>;
                        rTest.sleep();
                        syncListenerR1.clearData();
                        syncListenerR2.clearData();
                        cout &lt;&lt; endl &lt;&lt; endl &lt;&lt; endl;

                } <span class="comment">// END if (ros::ok())</span>
        } <span class="comment">// END if(doTesting)</span>

<span class="comment">/*</span>
<span class="comment">        if(doTesting) {</span>
<span class="comment">                Ptr&lt;of2::FabMap&gt; fabmap2;</span>
<span class="comment">                vector&lt;of2::IMatch&gt; matches2;</span>
<span class="comment">                fabmap2 = new of2::FabMap2(storage-&gt;clTree, 0.4, 0, of2::FabMap::SAMPLED | of2::FabMap::CHOW_LIU);</span>
<span class="comment">                fabmap2-&gt;addTraining(storage-&gt;trainBOWDescriptors_allRobots);</span>
<span class="comment"></span>
<span class="comment">                CentralStorage* storage2 =  new CentralStorage(2);</span>
<span class="comment">                storage2-&gt;testBOWDescriptors_allRobots = storage-&gt;testBOWDescriptors_allRobots;</span>
<span class="comment">                storage2-&gt;kFrames = storage-&gt;kFrames;</span>
<span class="comment"></span>
<span class="comment">                fabmap2-&gt;compare(storage2-&gt;testBOWDescriptors_allRobots, storage2-&gt;matches, true);</span>
<span class="comment"></span>
<span class="comment">                cout &lt;&lt; endl&lt;&lt;endl&lt;&lt; &quot;FABMAP FINAL: &quot; &lt;&lt; endl;</span>
<span class="comment">                helperDispOutput(storage2,true,&quot;testImgs/robot1MatchMatrixEnd.jpg&quot;,&quot;testImgs/robot1MatchMatrixFileEnd.yml&quot;);</span>
<span class="comment">                waitKey(100);</span>
<span class="comment">        }</span>
<span class="comment">*/</span>
        storage-&gt;<a class="code" href="classCentralStorage.html#a02c77a753e14f274385b5df7cfee2f1f">~CentralStorage</a>();
        cout &lt;&lt; <span class="stringliteral">&quot;END OF PROGRAM --------------------------------&quot;</span> &lt;&lt; endl;
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a86ca509bae31acb2c5b5d1e0326cabe8"></a><!-- doxytag: member="cc_fabmap_node.cpp::skipmatch" ref="a86ca509bae31acb2c5b5d1e0326cabe8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="cc__fabmap__node_8cpp.html#a86ca509bae31acb2c5b5d1e0326cabe8">skipmatch</a> = 0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cc__fabmap__node_8cpp_source.html#l00039">39</a> of file <a class="el" href="cc__fabmap__node_8cpp_source.html">cc_fabmap_node.cpp</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Sat May 23 2015 13:37:28 for My Project by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
